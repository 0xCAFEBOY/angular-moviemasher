!function(){"use strict";var a=function(a){console.error("response error",a);var b,c=0,d=[];for(b=a[c];b;)d.push(b),c++,b=a[c];return d.join("")},b=function(a,b){return a-b[0].getBoundingClientRect().left},c=function(a,b){var c,d;if(a){if(a.indexOf)return a.indexOf(b);for(d=a.length,c=0;d>c;c++)if(a[c]===b)return c}return-1},d=function(a){for(var b;a&&!(b=a.data("amm-directive"));)a=a.parent();return a},e=angular.module("angular.moviemasher",["ngResource","colorpicker.module","angularFileUpload"]);e.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,a.defaults.withCredentials=!0}]),e.factory("AmmRestMedia",["$resource",function(a){return a("php/media.php?group=:group",{group:"@group"},{search:{method:"GET",isArray:!0}})}]),e.factory("AmmRestMash",["$resource",function(a){return a("",{id:"@id"},{data:{url:"php/mash.php?id=:id",method:"GET",isArray:!1},save:{url:"php/save.php?id=:id",method:"POST",isArray:!1}})}]),e.factory("AmmRestExport",["$resource",function(a){return a("",{},{init:{method:"POST",url:"php/export_init.php"},monitor:{method:"POST",url:"php/export_monitor.php"}})}]),e.factory("AmmRestImport",["$resource",function(a){return a("",{},{init:{method:"POST",url:"php/import_init.php"},api:{method:"POST",url:"php/import_api.php"},monitor:{method:"POST",url:"php/import_monitor.php"}})}]),e.config(["$provide",function(a){var b=["$http"],c=MovieMasher,d=c.prototype;c.$inject=b,d.initialize=function(){this.registered=c.registered,this.supported=c.supported;var a,d=b.length;for(this.amm_injected={},a=0;d>a;a++)this.amm_injected[b[a]]=this.instance_arguments[a]},d.__player=null,Object.defineProperty(d,"player",{get:function(){return this.__player||(this.__player=c.player()),this.__player},set:function(a){this.__player=a}}),a.service("$amm",c)}]),e.directive("ammUi",["$amm",function(b){return{restrict:"AEC",controller:["$scope","AmmRestMedia","AmmRestMash","AmmRestExport","$window","$interval",function(c,d,e,f,g,h){var i=-1;b.player.did=function(a){a&&i>=b.player.action_index&&(i=-2)},c.amm_export_displayed_status=function(){c.amm_export_completed=0},c.amm_export_completed=0,c.amm_import_completed=0,c.amm_export_status="",c.amm_import_status="";var j=function(b,d){var e=!1,g=0;g=h(function(){e||(e=!0,f.monitor(b,function(b){if(e=!1,b.ok){if(b.completed>0&&b.completed<1)c.amm_export_completed=Math.max(.03,b.completed);else if(h.cancel(g),1===b.completed){var f=k(d);f&&(f.source=b.source),c.amm_export_completed=0}}else c.amm_export_status=b.error||a(b),c.amm_export_completed=-1,h.cancel(g)},function(a){console.error("AmmRestExport.monitor",a),c.amm_export_status="error response from export monitor",c.amm_export_completed=-1,h.cancel(g)}))},5e3)};b.render=function(){var d=b.mash_id;c.amm_export_completed=.01,f.init({id:d},function(b){b.ok?(c.amm_export_completed=.02,j(b,d)):(c.amm_export_status=b.error||a(b),c.amm_export_completed=-1)})},b.can=function(a){var c=!1;switch(a){case"render":c=b.player.duration&&!b.can("save");break;case"save":c=i!==b.player.action_index}return c},b.save=function(c){var d=b.mash_id,f=b.player.action_index;e.save({id:d},b.player.mash,function(e){if(e.ok){if(d===b.mash_id){i=f,l[d]&&delete l[d];var h=k(d);h&&(h.label=b.player.mash.label),c&&(b.mash_id=c,b.mash_id_change())}}else g.alert(e.error||a(e))})};var k=function(a){var c,d=b.mashes.length;for(c=0;d>c;c++)if(b.mashes[c].id===a)return b.mashes[c];return!1},l={};c.amm_view_mash=function(){g.open(b.selected_mash.source)},b.mash_id_change=function(){var c=b.mash_id,d=b.player.mash.id;if(b.can("save"))b.mash_id=d,g.confirm('Save changes to "'+b.player.mash.label+'"?')&&b.save(c);else{var f={};if(c){var h=k(c);h&&(b.selected_mash=h,f.label=h.label,f.id=c,l[c]||e.data({id:c},function(d){d.ok?c===b.mash_id&&(i=-1,b.player.mash=d.data):g.alert(d.error||a(d))}))}else f.label="New Untitled Mash",f.id=b.player.uuid(),l[f.id]=!0,b.mashes.push(f),b.mash_id=f.id,b.selected_mash=f;b.mash_id===f.id&&(i=-1,b.player.mash=f)}},b.mashes=[],b.mash_id=0,d.search({group:"mash"},function(a){a.length&&(angular.forEach(a,function(a){b.mashes.push(a)}),b.mash_id=b.mashes[0].id),b.mash_id_change()}),c.$amm=b,c.log_mash=function(){console.log("mash",b.player.mash)},c.amm_style_media_icon=function(a){var b,c={};if(a.icon)b=a.icon;else switch(a.type){case"image":b=a.url||a.source;break;case"audio":b=a.wave}return"audio"===a.type&&(c["background-size"]="100% 100%"),b&&(c["background-image"]="url("+b+")"),c}}]}}]),e.directive("ammPlayer",["$window","$amm",function(a,b){return{restrict:"AEC",replace:!1,template:'<canvas id="amm-canvas"></canvas>',link:function(c,d){if(a.CanvasRenderingContext2D){var e=d.find("canvas"),f=d[0].getBoundingClientRect();e.attr("width",f.width),e.attr("height",f.height),b.player.canvas_context=e[0].getContext("2d"),d.on("$destroy",function(){b.player.destroy()})}}}}]),e.directive("ammBrowser",["$timeout","$interval","$amm","AmmRestImport","AmmRestMedia",function(b,c,d,e,f){return{restrict:"AEC",replace:!1,controller:["$scope","FileUploader",function(d,f){d.amm_import_displayed_status=function(){var a,b,c;for(c=h.length,b=0;c>b;b++)if(a=h[b],-1===a.completed){h.splice(b,1);break}i()};var g=d.uploader=new f({scope:d}),h=[],i=function(){var a,b,c,e=0,f=0;for(c=h.length,b=0;c>b;b++){if(a=h[b],-1===a.completed)return d.amm_import_completed=-1,void(d.amm_import_status=a.status);f++,e+=a.completed}d.amm_import_completed=f?e/f:0,d.amm_import_status=""},j=function(a){var b,c,d=h.length;for(c=0;d>c;c++)if(b=h[c],b.upload===a)return b;return!1},k=function(b){var f=!1;b.interval_id=0,b.interval_id=c(function(){f||(f=!0,console.log("Calling AmmRestImport.monitor",b.monitor),e.monitor(b.monitor,function(e){if(console.log("AmmRestImport.monitor",e),f=!1,e.ok)if(e.completed>0&&e.completed<1)b.completed=.5+e.completed/2;else{if(c.cancel(b.interval_id),e.type){var g=e.type;"video"===g&&e.no_video&&"false"!==e.no_video&&(g="audio"),d.amm_browser_group_change(g)}else console.error("import_monitor_response did not include type key",e);var j=h.indexOf(b);j>-1?h.splice(j,1):console.error("could not delete upload",b)}else b.completed=-1,b.status=e.error||a(e),c.cancel(b.interval_id);i()},function(a){console.error("AmmRestImport.monitor",a),b.status="error getting response from monitor cgi",b.completed=-1,c.cancel(b.interval_id),i()}))},5e3)};g.onProgressItem=function(a,b){var c=j(a);c?(c.completed=Math.max(.03,b/200),i()):console.error("could not find upload for item",a)},g.onAfterAddingFile=function(b){var c={};c.file=b.file.name,c.size=b.file.size,c.type=b.file.type;var d={};d.uploading=!0,d.upload=b,d.completed=.01,d.name=c.name,h.unshift(d),i(),console.log("calling AmmRestImport.init",c),e.init(c,function(c){console.log("AmmRestImport.init",c),c.ok?(d.completed=.02,b.formData.push(c.data),d.api=c.api,b.url=c.endpoint,b.upload()):(d.completed=-1,d.status=c.error||a(c),i())})},g.onSuccessItem=function(c,d){var f;f=j(c),f?d.error?(f.status=d.error,f.completed=-1):f.api?(f.completed=.5,b(function(){console.log("Calling AmmRestImport.api",f.api),e.api(f.api,function(b){console.log("AmmRestImport.api",b),b.ok?(f.monitor=b.monitor,f.completed=.51,k(f)):(f.status=b.error||a(b),f.completed=-1),i()})},20)):console.error("upload had no api key?",f):console.error("could not find upload for item?",c),i()},g.onErrorItem=function(a){console.error("uploading file",arguments);var b=j(a);b?(b.status="problem uploading "+b.file,b.completed=-1,i()):console.error("could not find upload for item",a)}}],link:function(a){var b={};d.MovieMasher.configure({mash:{"default":{quantize:10}}}),f.search({group:"font"},function(a){d.MovieMasher.register("font",a)}),f.search({group:"scaler"},function(a){d.MovieMasher.register("scaler",a)}),f.search({group:"merger"},function(a){d.MovieMasher.register("merger",a)}),a.amm_browser_group="theme",a.amm_browser_group_change=function(c){c&&(a.amm_browser_group=c,b[a.amm_browser_group]&&delete b[a.amm_browser_group]),b[a.amm_browser_group]||(b[a.amm_browser_group]=f.search({group:a.amm_browser_group})),a.amm_media=b[a.amm_browser_group]},a.amm_browser_group_change()}}}]),e.directive("ammDragMedia",["$amm","$parse",function(a,b){return{restrict:"AEC",templateUrl:"views/browser/clip.html",link:function(a,c,d){c.attr("draggable",!0),c.bind("dragstart",function(c){var e=d.ammDragMedia,f=b(e)(a),g={media:f,x:c.layerX,y:c.layerY},h="amm-"+f.type;c.dataTransfer.effectAllowed="link",c.dataTransfer.setData(h,angular.toJson(g))})}}}]),e.directive("ammInspector",["$amm",function(a){return{restrict:"AEC",replace:!1,link:function(b){b.amm_inspector_include=function(b){var c,d;if(b)if(b===a.player.mash)c="views/inspector/mash.html";else if(d=a.player.media(b))if(d.inspector)c=d.inspector;else switch(d.type){case"theme":case"transition":if(d.html){c=d.html;break}case"video":case"audio":case"image":c="views/inspector/"+d.type+".html";break;default:c=d.html}return c}}}}]),e.directive("ammInspectorEffects",["$amm",function(a){return{restrict:"AEC",controller:["$scope","$element","$amm",function(a,b){var e=this,f=function(a){var b,d,e,f=["amm-effects","amm-effect"];for(e=f.length,d=0;e>d;d++)if(b=f[d],-1<c(a,b))return b;return!1},g=function(a){return Array.prototype.indexOf.call(a[0].parentNode.childNodes,a[0])};e.__effects_drag_data=function(c,h){var i,j,k,l,m,n,o;if(c&&(j=f(c.dataTransfer.types))){for(m=!0,k={type:j,multiple:"amm-effects"===j,over_index:-1},h&&(k.data=c.dataTransfer.getData(j),k.data&&(k.data=angular.fromJson(k.data))),i={},o=angular.element(c.target);o&&(o=d(o))&&(n=o.data("amm-directive"),"ammInspectorEffects"!==n);)i[n]=o,o=o.parent();i.ammInspectorEffect&&(l=i.ammInspectorEffect,k.effect=l.data("amm-object"))}return(e.__over_effect_element!==l||e.__drop_ok!==m)&&a.$apply(function(){e.__over_effect_element!==l&&(e.__over_effect_element&&e.__over_effect_element.toggleClass("amm-drop-dragover",!1),e.__over_effect_element=l,e.__over_effect_element&&(k.over_index=g(l),e.__over_effect_element.toggleClass("amm-drop-dragover",!0))),e.__drop_ok!==m&&(e.__drop_ok=m,b.toggleClass("amm-drop-dragover",e.__drop_ok))}),m&&(c.preventDefault(),c.dataTransfer.dropEffect=k.multiple?"move":"link"),k}}],link:function(b,c,d,e){c.data("amm-directive","ammInspectorEffects"),c.bind("dragenter",e.__effects_drag_data),c.bind("dragover",e.__effects_drag_data),c.bind("dragleave",function(){e.__effects_drag_data()}),c.bind("drop",function(d){var f,g,h=e.__effects_drag_data(d,!0);h&&(f=a.player.selectedClipOrMash.effects,g=h.over_index,-1===g&&(g=f.length),b.$apply(function(){c.toggleClass("amm-drop-dragover",!1),h.multiple?a.player.move(a.player.selectedEffects,"effect",g):a.player.add(h.data.media,"effect",g)}),d.stopPropagation&&d.stopPropagation(),d.preventDefault())}),c.bind("dragend",function(c){"none"===c.dataTransfer.dropEffect&&b.$apply(function(){a.player.remove(a.player.selectedEffects,"effect")})})}}}]),e.directive("ammInspectorEffect",["$amm","$parse",function(a,b){return{restrict:"A",link:function(c,d,e){d.data("amm-directive","ammInspectorEffect"),d.data("amm-object",c.effect);var f=b(e.ammInspectorEffect)(c);d.attr("draggable",!0),d.bind("dragstart",function(b){if(a.player.selected(f)){var c={effects:a.player.selectedEffects,x:b.layerX,y:b.layerY};b.dataTransfer.effectAllowed="moveCopy",b.dataTransfer.setData("amm-effects",angular.toJson(c))}else b.stopPropagation&&b.stopPropagation(),b.preventDefault()})}}}]),e.directive("ammTimeline",["$amm",function(){return{restrict:"AEC"}}]),e.directive("ammTimelineTrackControls",["$amm",function(){return{restrict:"AEC",link:function(a,b){a.amm_timeline_scroll=function(c){a.$apply(function(){b[0].scrollTop=c.target.scrollTop})}}}}]),e.directive("ammTimelineTracks",["$amm","$window","$rootScope",function(a,e,f){return e.onresize=function(){f.$apply(function(){})},{restrict:"AEC",controller:["$scope","$element","$amm",function(a,b,e){var f=this,g=function(a){var b,d,e,f=["amm-clips-audio","amm-clips-overlays","amm-clips-video","amm-transition","amm-image","amm-frame","amm-theme","amm-video","amm-audio"];for(e=f.length,d=0;e>d;d++)if(b=f[d],-1<c(a,b))return b;return!1},h=function(a,b){var c,d=0;return a&&(c=f.pixels_per_second(),c&&(d=a/e.player.mash.quantize*c,(b||"undefined"==typeof b)&&(d=Math[b||"ceil"](d)))),d};f.frame_from_pixels=function(a,b){var c,d=0;return a&&(c=f.pixels_per_second(),c&&(d=a/c*e.player.mash.quantize,(b||"undefined"==typeof b)&&(d=Math[b||"round"](d)))),d},f.pixels_per_second=function(b){var c,d=0,f=b?0:20;return c=e.player?e.player.duration:0,c&&(d=(a.amm_timeline_width()-f)/(c*(1.01-Math.max(.01,Math.min(1,a.amm_zoom))))),d},f.timeline_drag_data=function(c,e){var h,i,j,k,l,m,n;if(c&&(i=g(c.dataTransfer.types))){for(j={type:i,multiple:"amm-clips-"===i.substr(0,10)},e&&(j.data=c.dataTransfer.getData(i),j.data&&(j.data=angular.fromJson(j.data))),h={},n=angular.element(c.target);n&&(n=d(n))&&(m=n.data("amm-directive"),"ammTimelineTracks"!==m);)h[m]=n,n=n.parent();h.ammTimelineTrack&&(j.track=h.ammTimelineTrack.data("amm-object"),h.ammTimelineClip&&(j.clip=h.ammTimelineClip.data("amm-object")),j.multiple?(l="amm-clips-"+j.track.type===j.type,l=l||"video"===j.track.type&&"amm-clips-overlays"===j.type):(l="amm-"+j.track.type===j.type,l||"video"!==j.track.type||(l="amm-transition"===j.type?!j.track.index:"amm-audio"!==j.type)),l&&(k=h.ammTimelineTrack))}return(f.__over_track_element!==k||f.__drop_ok!==l)&&a.$apply(function(){f.__over_track_element!==k&&(f.__over_track_element&&f.__over_track_element.toggleClass("amm-drop-dragover",!1),f.__over_track_element=k,f.__over_track_element&&f.__over_track_element.toggleClass("amm-drop-dragover",!0)),f.__drop_ok!==l&&(f.__drop_ok=l,b.parent().toggleClass("amm-drop-dragover",f.__drop_ok))}),l&&(c.preventDefault(),c.dataTransfer.dropEffect=j.multiple?"move":"link"),j},f.track_for_clips=function(a){var b,c,d=a.length;for(c=0;d>c;c++){switch(e.player.media(a[c]).type){case"audio":b="audio";break;case"transition":b="video"}if(b)break}return b||(b="overlays"),b},a.amm_selected_class=function(a){return{"amm-selected":e.player.selected(a)}},a.amm_style_clip=function(a,b){var c={},d=e.player.media(a);return c.width=h(a.length,"floor")+"px",c["z-index"]=100*("transition"===d.type?10:1)+b.clips.indexOf(a),c.left=h(a.frame,"floor")+"px",c.position="absolute",c},a.amm_timeline_view_width=function(){var b,c=e.player?e.player.duration:0;return b=c?c*f.pixels_per_second(!0):a.amm_timeline_width()},a.amm_timeline_width=function(){return b[0].getBoundingClientRect().width},a.amm_zoom=0}],link:function(c,d,e,f){d.data("amm-directive","ammTimelineTracks"),e.$set("class","amm-timeline-tracks"),d.bind("scroll",c.amm_timeline_scroll),d.bind("dragenter",f.timeline_drag_data),d.bind("dragover",f.timeline_drag_data),d.bind("dragleave",function(){f.timeline_drag_data()}),d.bind("drop",function(e){var g,h,i,j,k=f.timeline_drag_data(e,!0);k&&(g=e.dataTransfer.dropEffect,f.timeline_drag_data(),j=a.player.mash.tracks[k.track.type],i=k.track.index,h="video"!==k.track.type||i?Math.max(0,f.frame_from_pixels(b(e.pageX,d)-k.data.x)):k.clip?k.track.clips.indexOf(k.clip):k.track.clips.length,c.$apply(function(){k.multiple?a.player.move(a.player.selectedClips,k.track.type,h,i):a.player.add(k.data.media,k.track.type,h,i)}),e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault())})}}}]),e.directive("ammTimelineTrack",["$amm",function(a){return{restrict:"AEC",link:function(b,c){c.data("amm-directive","ammTimelineTrack"),c.data("amm-object",b.track),c.bind("mousedown",function(){b.$apply(function(){a.player.select(!1)})})}}}]),e.directive("ammTimelineClip",["$amm","$parse",function(a){return{restrict:"E",require:"^ammTimelineTracks",templateUrl:"views/timeline/clip.html",replace:!0,link:function(b,c,d,e){c.data("amm-directive","ammTimelineClip"),c.data("amm-object",b.clip),c.bind("mousedown",function(c){b.$apply(function(){a.player.select(b.clip,c.shiftKey),c.stopPropagation&&c.stopPropagation()})}),c.bind("dragstart",function(c){if(a.player.selected(b.clip)){c.dataTransfer.effectAllowed="moveCopy";var d,f,g,h,i,j={},k={clips:a.player.selectedClips,x:c.layerX,y:c.layerY,media:[]};for(h=k.clips.length,d=h>1?c.dataTransfer.addElement:!1,g=0;h>g;g++)f=k.clips[g],i=a.player.media(f),j[i.id]||(j[i.id]=!0,k.media.push(i));c.dataTransfer.setData("amm-clips-"+e.track_for_clips(k.clips),angular.toJson(k))}else c.stopPropagation&&c.stopPropagation(),c.preventDefault()}),c.bind("dragend",function(c){"none"===c.dataTransfer.dropEffect&&b.$apply(function(){a.player.remove(a.player.selectedClips,b.track.type,b.track.index)})}),c.on("$destroy",function(){c.data("amm-object",null),c.data("amm-directive",null)})}}}]),e.directive("ammCanvasContainer",["$amm","AmmRestMedia",function(a){return{restrict:"AEC",replace:!1,link:function(b,c){a.player.canvas_container=c[0],a.player.redraw(),c.on("$destroy",function(){a.player.canvas_container=null,a.player.redraw()})}}}]),e.directive("ammSynced",["$amm","$interval",function(a,b){return{restrict:"AEC",link:function(){b(function(){},100)}}}]),e.filter("secondsFromFrames",function(){return function(a,b){return a/b}}),e.filter("displaySeconds",function(){var a=function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a};return function(b,c,d){var e,f,g,h="";return d||(d=b),e=3600,f=2,d>=e&&(b>=e?(h+=a(String(Math.floor(b/e)),f),g=!0,b%=e):h+="00:"),e=60,(g||d>=e)&&(g&&(h+=":"),b>=e?(h+=a(String(Math.floor(b/e)),f),g=!0,b%=e):h+="00:"),e=1,g||d>=e?(g&&(h+=":"),b>=e?(h+=a(String(Math.floor(b/e)),f),g=!0,b%=e):h+="00"):h+="00",c>1&&(10===c&&(f=1),h+=".",b?(b=1===f?Math.floor(10*b)/10:Math.floor(100*b)/100,b=Number(String(b).substr(2,2)),h+=a(String(b),f)):h+=a("0",f)),h}})}();